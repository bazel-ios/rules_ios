# Tests for Xcode project generation targeting the iOS platform

This directory contains scripts used to test if the projects generated by the `xcodeproj` rule contain the expected outputs. Such type of integration test is necessary to ensure all shims in `tools/xcodeproj_shims` are consistent with `xcodebuild`.

The callsite can be found in `tests/xcodeproj-tests.sh`. In general this script invokes `bazel run` for all `xcodeproj` rules in `tests/ios/xcodeproj/BUILD.bazel` and then runs these checks (note that the order matters):
```sh
./tests/ios/xcodeproj/pre_build_check.sh
./tests/ios/xcodeproj/build.sh
./tests/ios/xcodeproj/post_build_check.sh
./tests/ios/xcodeproj/tests.sh
```

Most of the relevant validation logic will be found in
```sh
tests/ios/xcodeproj/post_build_check.sh
```

## Search Paths

In `tests/ios/xcodeproj/post_build_check.sh` one will find these messages
```sh
echo "Make sure hmap files exist after build"
echo "Make sure framework search paths exist after build"
```
, the code for each is scanning the `HEADER_SEARCH_PATHS` and `FRAMEWORK_SEARCH_PATHS` for all generated Xcode projects and asserting that all files exist.

## LLDB and `.swift` files in mixed projects

In mixed projects (`swift` & `Objective-C`) additional configuration is required to work with LLDB otherwise it won't be able to find where bazel is generating the expected outputs.

The `xcodeproj` gives Xcode paths to [LLDB configuration files](https://lldb.llvm.org/man/lldb.html#configuration-files) (see [here](https://github.com/bazel-ios/rules_ios/blob/e696157d3003dc3aac2f0d7f3aa62f214fbcb0a0/rules/xcodeproj.bzl#L623-L628)) and the script reponsible for adding LLDB settings to those files is:
```sh
tools/xcodeproj_shims/installers/lldb-settings.sh
```

LLDB can be configured in many different ways (read more [here](https://github.com/apple/swift-lldb/blob/d74be846ef3e62de946df343e8c234bde93a8912/source/Target/TargetProperties.td#L169-L171)). In particular, to ensure the debugger works with `.swift` files that depend on `Objective-C` (via bridging headers, for example) this setting is required
```sh
settings set -- target.swift-extra-clang-flags
```
and all `HEADER_SEARCH_PATHS` and `FRAMEWORK_SEARCH_PATHS` for the respective target have to be passed in to this flag. This ensures `clang` knows where to find all frameworks included via `-F` and headers and header maps included via `-I`.

In `tests/ios/xcodeproj/post_build_check.sh` one will find this message
```sh
echo "Make sure all LLDB configuration files contain the expexted search paths"
```
, the code that follows is testing exactly what was described above by comparing the `target.swift-extra-clang-flags` setting in the generated `.lldbinit` file with the `HEADER_SEARCH_PATHS` and `FRAMEWORK_SEARCH_PATHS` extracted using `xcodebuild` with the `-showBuildSettings` flag.